jobs:
  coverity:
    name: Coverity Connect Scan (Windows)
    # Choose ONE of the following:
    # runs-on: windows-latest                 # GitHub-hosted Windows
    runs-on: [self-hosted, windows]           # Self-hosted Windows runner

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: "Add Coverity tools to PATH (Windows)"
        shell: pwsh
        run: |
          if (-not "$env:COVERITY_BIN_DIR") {
            Write-Error "COVERITY_BIN_DIR not set. Set it in GitHub â†’ Variables."
          }
          echo "$env:COVERITY_BIN_DIR" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          Write-Host "Checking tool availability..."
          Get-Command cov-build -ErrorAction SilentlyContinue
          Get-Command cov-analyze -ErrorAction SilentlyContinue
          Get-Command cov-commit-defects -ErrorAction SilentlyContinue

      - name: "Prepare cov-int directory"
        shell: pwsh
        run: |
          if (Test-Path "cov-int") { Remove-Item -Recurse -Force cov-int }
          New-Item -ItemType Directory -Path cov-int | Out-Null

      - name: "Build (.NET example) through cov-build"
        shell: pwsh
        run: |
          cov-build --dir cov-int --fs-capture-search . -- dotnet build --configuration Release

      - name: "Cov-Analyze"
        shell: pwsh
        run: |
          cov-analyze --dir cov-int --all --webapp-security

      - name: "Commit defects (username/password)"
        if: ${{ env.COVERITY_USER != '' && env.COVERITY_PASSWORD != '' }}
        shell: pwsh
        run: |
          $args = ""
          if ("$env:COVERITY_PROJECT" -ne "") {
            $args = "--scm-project-name $env:COVERITY_PROJECT"
          }
          cov-commit-defects `
            --dir cov-int `
            --url "$env:COVERITY_CONNECT_URL" `
            --stream "$env:COVERITY_STREAM" `
            --username "$env:COVERITY_USER" `
            --password "$env:COVERITY_PASSWORD" `
            $args

      - name: "Commit defects (token)"
        if: ${{ env.COVERITY_AUTH_TOKEN != '' }}
        shell: pwsh
        run: |
          $args = ""
          if ("$env:COVERITY_PROJECT" -ne "") {
            $args = "--scm-project-name $env:COVERITY_PROJECT"
          }
          $tokenFile = "cov_token.txt"
          Set-Content -Path $tokenFile -Value $env:COVERITY_AUTH_TOKEN
          cov-commit-defects `
            --dir cov-int `
            --url "$env:COVERITY_CONNECT_URL" `
            --stream "$env:COVERITY_STREAM" `
            --auth-key-file $tokenFile `
            $args
