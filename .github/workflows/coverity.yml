name: Coverity Connect Scan (Windows, Self-Hosted)

on:
  push:
    branches: [ "main" ]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

# Prevent overlapping runs for the same ref
concurrency:
  group: coverity-${{ github.ref }}
  cancel-in-progress: false

env:
  # ---- Coverity Connect server & metadata ----
  COVERITY_CONNECT_URL: ${{ vars.COVERITY_CONNECT_URL }}
  COVERITY_STREAM:       ${{ vars.COVERITY_STREAM }}
  COVERITY_PROJECT:      ${{ vars.COVERITY_PROJECT }}

  # ---- Local Windows path to your Coverity CLI ----
  # If using Black Duck Desktop tools, set to its bin path, e.g.:
  # C:\Users\TracyChrisinger\AppData\Roaming\BlackDuck\desktop\controller\installedtools\coverity-analysis\2025.12.0\bin
  COVERITY_BIN_DIR:      C:\Coverity\bin

  # Optional: fail fast if a 32-bit shell is used
  REQUIRE_64BIT_PWSH:    true

jobs:
  coverity:
    name: Coverity Connect Scan (Windows)
    runs-on:
      - self-hosted
      - windows
      - x64
    timeout-minutes: 90

    defaults:
      run:
        shell: pwsh  # ensure 64-bit PowerShell Core for all steps

    steps:
      # -----------------------------------------------------------
      # CHECKOUT
      # -----------------------------------------------------------
      - name: Checkout source
        uses: actions/checkout@v4

      # -----------------------------------------------------------
      # VERIFY RUNNER & SHELL ARCH
      # -----------------------------------------------------------
      - name: Verify runner environment (64-bit)
        run: |
          Write-Host "Runner OS: $env:RUNNER_OS"
          Write-Host "pwsh version: $($PSVersionTable.PSVersion)"
          Write-Host "Is64BitOperatingSystem: $([Environment]::Is64BitOperatingSystem)"
          Write-Host "Is64BitProcess:         $([Environment]::Is64BitProcess)"
          Write-Host "PROCESSOR_ARCHITECTURE: $env:PROCESSOR_ARCHITECTURE"
          if ($env:RUNNER_OS -ne "Windows") { throw "This job requires a Windows self-hosted runner." }
          if ($env:REQUIRE_64BIT_PWSH -eq "true" -and -not [Environment]::Is64BitProcess) {
            throw "This step requires 64-bit PowerShell. Current process is 32-bit."
          }

      # -----------------------------------------------------------
      # ADD COVERITY TO PATH (with unblocking & existence checks)
      # -----------------------------------------------------------
      - name: Add Coverity tools to PATH
        run: |
          $bin = "${env:COVERITY_BIN_DIR}"
          if (-not (Test-Path $bin)) {
            throw "COVERITY_BIN_DIR not found: $bin"
          }

          # Unblock EXEs that may have Zone.Identifier
          Get-ChildItem -Path $bin -File -Filter "cov-*.exe" -ErrorAction SilentlyContinue | ForEach-Object {
            $streams = Get-Item $_.FullName -Stream * -ErrorAction SilentlyContinue
            if ($streams -and $streams.Stream -contains 'Zone.Identifier') {
              Unblock-File $_.FullName
              Write-Host "Unblocked: $($_.FullName)"
            }
          }

          Write-Host "Adding to PATH: $bin"
          $bin | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      # -----------------------------------------------------------
      # VERIFY COVERITY CLI (tolerant exit codes; capture stdout/stderr)
      # -----------------------------------------------------------
      - name: Verify Coverity CLI presence & runnable
        run: |
          # Resolve tool paths first
          $tools = @('cov-build','cov-analyze','cov-commit-defects')
          $missing = @()
          $resolved = @{}
          foreach ($t in $tools) {
            $cmd = Get-Command $t -ErrorAction SilentlyContinue
            if (-not $cmd) { $missing += $t } else { $resolved[$t] = $cmd.Source }
          }
          if ($missing) { throw "Missing Coverity tools on PATH: $($missing -join ', ')" }

          Write-Host ("cov-build:          {0}" -f $resolved['cov-build'])
          Write-Host ("cov-analyze:        {0}" -f $resolved['cov-analyze'])
          Write-Host ("cov-commit-defects: {0}" -f $resolved['cov-commit-defects'])

          # Helper to run a tool, accept specific exit codes, and show diagnostics
          # We'll inline for each tool to avoid function scoping pitfalls.

          # ---- Probe: cov-build (accept 0 or 2 for --help) ----
          $exePath = $resolved['cov-build']
          $args = @('--help')
          $accept = @(0,2)
          $tmpBase = Join-Path $env:RUNNER_TEMP ([IO.Path]::GetRandomFileName())
          $outFile = "$tmpBase.out.txt"
          $errFile = "$tmpBase.err.txt"
          $null = & $exePath @args 2> $errFile | Out-File -FilePath $outFile -Encoding utf8
          $exit = $LASTEXITCODE
          if ($accept -notcontains $exit) {
            $stderr = (Test-Path $errFile) ? (Get-Content $errFile -Raw) : "<no stderr>"
            $stdout = (Test-Path $outFile) ? (Get-Content $outFile -Raw) : "<no stdout>"
            throw ("cov-build {0} failed with exit code {1}.`nSTDERR:`n{2}`nSTDOUT:`n{3}" -f ($args -join ' '), $exit, $stderr, $stdout)
          } else {
            Write-Host ("cov-build {0} succeeded with exit code {1}" -f ($args -join ' '), $exit)
          }

          # ---- Probe: cov-analyze (prefer --version==0; fallback to --help accept 0,2) ----
          $exePath = $resolved['cov-analyze']
          $ok = $false
          $args = @('--version')
          $accept = @(0)
          $tmpBase = Join-Path $env:RUNNER_TEMP ([IO.Path]::GetRandomFileName())
          $outFile = "$tmpBase.out.txt"
          $errFile = "$tmpBase.err.txt"
          $null = & $exePath @args 2> $errFile | Out-File -FilePath $outFile -Encoding utf8
          $exit = $LASTEXITCODE
          if ($accept -contains $exit) {
            Write-Host ("cov-analyze {0} succeeded with exit code {1}" -f ($args -join ' '), $exit)
            $ok = $true
          } else {
            Write-Warning "cov-analyze --version failed; trying --help"
          }
          if (-not $ok) {
            $args = @('--help')
            $accept = @(0,2)
            $tmpBase = Join-Path $env:RUNNER_TEMP ([IO.Path]::GetRandomFileName())
            $outFile = "$tmpBase.out.txt"
            $errFile = "$tmpBase.err.txt"
            $null = & $exePath @args 2> $errFile | Out-File -FilePath $outFile -Encoding utf8
            $exit = $LASTEXITCODE
            if ($accept -notcontains $exit) {
              $stderr = (Test-Path $errFile) ? (Get-Content $errFile -Raw) : "<no stderr>"
              $stdout = (Test-Path $outFile) ? (Get-Content $outFile -Raw) : "<no stdout>"
              throw ("cov-analyze {0} failed with exit code {1}.`nSTDERR:`n{2}`nSTDOUT:`n{3}" -f ($args -join ' '), $exit, $stderr, $stdout)
            } else {
              Write-Host ("cov-analyze {0} succeeded with exit code {1}" -f ($args -join ' '), $exit)
            }
          }

          # ---- Probe: cov-commit-defects (try --version==0; fallback --help accept 0,1,2) ----
          $exePath = $resolved['cov-commit-defects']
          $ok = $false
          $args = @('--version')
          $accept = @(0)
          $tmpBase = Join-Path $env:RUNNER_TEMP ([IO.Path]::GetRandomFileName())
          $outFile = "$tmpBase.out.txt"
          $errFile = "$tmpBase.err.txt"
          $null = & $exePath @args 2> $errFile | Out-File -FilePath $outFile -Encoding utf8
          $exit = $LASTEXITCODE
          if ($accept -contains $exit) {
            Write-Host ("cov-commit-defects {0} succeeded with exit code {1}" -f ($args -join ' '), $exit)
            $ok = $true
          } else {
            Write-Warning "cov-commit-defects --version failed; trying --help"
          }
          if (-not $ok) {
            $args = @('--help')
            $accept = @(0,1,2)
            $tmpBase = Join-Path $env:RUNNER_TEMP ([IO.Path]::GetRandomFileName())
            $outFile = "$tmpBase.out.txt"
            $errFile = "$tmpBase.err.txt"
            $null = & $exePath @args 2> $errFile | Out-File -FilePath $outFile -Encoding utf8
            $exit = $LASTEXITCODE
            if ($accept -notcontains $exit) {
              $stderr = (Test-Path $errFile) ? (Get-Content $errFile -Raw) : "<no stderr>"
              $stdout = (Test-Path $outFile) ? (Get-Content $outFile -Raw) : "<no stdout>"
              throw ("cov-commit-defects {0} failed with exit code {1}.`nSTDERR:`n{2}`nSTDOUT:`n{3}" -f ($args -join ' '), $exit, $stderr, $stdout)
            } else {
              Write-Host ("cov-commit-defects {0} succeeded with exit code {1}" -f ($args -join ' '), $exit)
            }
          }

      # -----------------------------------------------------------
      # PREPARE cov-int
      # -----------------------------------------------------------
      - name: Prepare cov-int directory
        run: |
          if (Test-Path "cov-int") { Remove-Item -Recurse -Force cov-int }
          New-Item -ItemType Directory -Path cov-int | Out-Null

      # -----------------------------------------------------------
      # BUILD — .NET / C#
      # -----------------------------------------------------------
      - name: Build (.NET) via cov-build
        run: |
          # Print dotnet info for troubleshooting
          dotnet --info

          # Use fs-capture for .NET builds
          cov-build --dir cov-int --fs-capture-search . -- dotnet build --configuration Release

      # -----------------------------------------------------------
      # ANALYZE
      # -----------------------------------------------------------
      - name: Cov-Analyze
        run: |
          cov-analyze --dir cov-int --all --webapp-security

      # -----------------------------------------------------------
      # COMMIT DEFECTS — USER/PASSWORD AUTH
      # -----------------------------------------------------------
      - name: Commit defects (username/password)
        if: ${{ env.COVERITY_USER != '' && env.COVERITY_PASSWORD != '' }}
        run: |
          $args = ""
          if ("$env:COVERITY_PROJECT" -ne "") {
            # careful quoting for a value with spaces
            $args = "--scm-project-name `"$env:COVERITY_PROJECT`""
          }

          cov-commit-defects `
            --dir cov-int `
            --url "$env:COVERITY_CONNECT_URL" `
            --stream "$env:COVERITY_STREAM" `
            --username "$env:COVERITY_USER" `
            --password "$env:COVERITY_PASSWORD" `
            $args

      # -----------------------------------------------------------
      # COMMIT DEFECTS — TOKEN AUTH
      # -----------------------------------------------------------
      - name: Commit defects (token)
        if: ${{ env.COVERITY_AUTH_TOKEN != '' }}
        run: |
          $args = ""
          if ("$env:COVERITY_PROJECT" -ne "") {
            $args = "--scm-project-name `"$env:COVERITY_PROJECT`""
          }

          $tokenFile = "cov_token.txt"
          Set-Content -Path $tokenFile -Value $env:COVERITY_AUTH_TOKEN -Encoding ascii

          cov-commit-defects `
            --dir cov-int `
            --url "$env:COVERITY_CONNECT_URL" `
            --stream "$env:COVERITY_STREAM" `
            --auth-key-file $tokenFile `
            $args
