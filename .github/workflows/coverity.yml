name: Coverity Connect Scan (Windows)

on:
  push:
    branches: [ "main" ]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

env:
  # ---- Your Coverity Connect server ----
  COVERITY_CONNECT_URL: ${{ vars.COVERITY_CONNECT_URL }}
  COVERITY_STREAM:       ${{ vars.COVERITY_STREAM }}
  COVERITY_PROJECT:      ${{ vars.COVERITY_PROJECT }}

  # ---- Windows path where tools will be available on the runner ----
  # If you install Coverity during the job, point this to that location.
  # Example if you unzip to RUNNER_TEMP: C:\Users\runneradmin\AppData\Local\Temp\coverity\bin
  COVERITY_BIN_DIR:      ${{ vars.COVERITY_BIN_DIR }}

  # ---- Credentials ----
  COVERITY_USER:         ${{ secrets.COVERITY_USER }}
  COVERITY_PASSWORD:     ${{ secrets.COVERITY_PASSWORD }}
  COVERITY_AUTH_TOKEN:   ${{ secrets.COVERITY_AUTH_TOKEN }}

jobs:
  coverity:
    name: Coverity Connect Scan (Windows)
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # OPTIONAL: Install Coverity tools on the GitHub-hosted runner.
      # Replace this placeholder with the actual download/installation method available to you
      # (internal artifact feed, private storage, or prepackaged zip).
      # Then set COVERITY_BIN_DIR to the extracted bin path (or echo it to PATH).
      # Example skeleton:
      # - name: Install Coverity CLI
      #   shell: pwsh
      #   run: |
      #     $dest = Join-Path $env:RUNNER_TEMP "coverity"
      #     New-Item -ItemType Directory -Path $dest -Force | Out-Null
      #     # Example: Invoke-WebRequest to your internal URL, then Expand-Archive
      #     # Invoke-WebRequest -Uri "https://your-internal-url/coverity.zip" -OutFile "$dest\cov.zip"
      #     # Expand-Archive -Path "$dest\cov.zip" -DestinationPath $dest -Force
      #     # Set COVERITY_BIN_DIR for this job if not using repo-level variable:
      #     # echo "$dest\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Add Coverity tools to PATH (Windows)
        shell: pwsh
        run: |
          if (-not "$env:COVERITY_BIN_DIR") {
            Write-Error "COVERITY_BIN_DIR not set. Set it (e.g., to the path where you installed/unzipped Coverity) or add an install step."
          }
          echo "$env:COVERITY_BIN_DIR" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          Write-Host "Checking tool availability..."
          $missing = @()
          foreach ($cmd in @('cov-build','cov-analyze','cov-commit-defects')) {
            if (-not (Get-Command $cmd -ErrorAction SilentlyContinue)) { $missing += $cmd }
          }
          if ($missing.Count -gt 0) {
            Write-Error "Missing Coverity tools: $($missing -join ', '). Ensure COVERITY_BIN_DIR is correct or install Coverity in a prior step."
          }

      - name: Prepare cov-int directory
        shell: pwsh
        run: |
          if (Test-Path "cov-int") { Remove-Item -Recurse -Force cov-int }
          New-Item -ItemType Directory -Path cov-int | Out-Null

      # =====================================================================
      # BUILD SECTION — Choose ONE based on your project type
      # =====================================================================

      # Example: .NET / C#
      - name: Build (.NET example) through cov-build
        shell: pwsh
        run: |
          cov-build --dir cov-int --fs-capture-search . -- dotnet build --configuration Release

      # Example: Java / Maven
      # - name: Build (Maven) through cov-build
      #   shell: pwsh
      #   run: |
      #     cov-build --dir cov-int --fs-capture-search . -- mvn -B -DskipTests clean package

      # Example: C/C++ (MSBuild)
      # - name: Build (MSBuild C/C++) through cov-build
      #   shell: pwsh
      #   run: |
      #     cov-build --dir cov-int --fs-capture-search . -- msbuild.exe MySolution.sln /p:Configuration=Release

      # =====================================================================
      # ANALYZE
      # =====================================================================
      - name: Cov-Analyze
        shell: pwsh
        run: |
          cov-analyze --dir cov-int --all --webapp-security

      # =====================================================================
      # COMMIT DEFECTS — USER/PASS
      # =====================================================================
      - name: Commit defects (username/password)
        if: ${{ env.COVERITY_USER != '' && env.COVERITY_PASSWORD != '' }}
        shell: pwsh
        run: |
          $args = ""
          if ("$env:COVERITY_PROJECT" -ne "") {
            $args = "--scm-project-name $env:COVERITY_PROJECT"
          }
          cov-commit-defects `
            --dir cov-int `
            --url "$env:COVERITY_CONNECT_URL" `
            --stream "$env:COVERITY_STREAM" `
            --username "$env:COVERITY_USER" `
            --password "$env:COVERITY_PASSWORD" `
            $args

      # =====================================================================
      # COMMIT DEFECTS — TOKEN
      # =====================================================================
      - name: Commit defects (token)
        if: ${{ env.COVERITY_AUTH_TOKEN != '' }}
        shell: pwsh
        run: |
          $args = ""
          if ("$env:COVERITY_PROJECT" -ne "") {
            $args = "--scm-project-name $env:COVERITY_PROJECT"
          }
          $tokenFile = "cov_token.txt"
          Set-Content -Path $tokenFile -Value $env:COVERITY_AUTH_TOKEN
          cov-commit-defects `
            --dir cov-int `
            --url "$env:COVERITY_CONNECT_URL" `
            --stream "$env:COVERITY_STREAM" `
            --auth-key-file $tokenFile `
            $args
