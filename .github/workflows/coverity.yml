name: Coverity Connect Scan (Windows, Self-Hosted)

on:
  push:
    branches: [ "main" ]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

# Prevent overlapping runs for the same ref
concurrency:
  group: coverity-${{ github.ref }}
  cancel-in-progress: false

env:
  # ---- Coverity Connect server & metadata ----
  COVERITY_CONNECT_URL: ${{ vars.COVERITY_CONNECT_URL }}
  COVERITY_STREAM:       ${{ vars.COVERITY_STREAM }}
  COVERITY_PROJECT:      ${{ vars.COVERITY_PROJECT }}

  # ---- Local Windows path to your Coverity CLI ----
  # If you use the Black Duck–installed tools already on PATH, you can keep this as-is
  # or set to the Black Duck tools path so it wins in PATH precedence:
  #   C:\Users\TracyChrisinger\AppData\Roaming\BlackDuck\desktop\controller\installedtools\coverity-analysis\2025.3.0\bin
  COVERITY_BIN_DIR:      C:\Coverity\bin

  # ---- Credentials (choose one auth path below) ----
  COVERITY_USER:         ${{ secrets.COVERITY_USER }}
  COVERITY_PASSWORD:     ${{ secrets.COVERITY_PASSWORD }}
  COVERITY_AUTH_TOKEN:   ${{ secrets.COVERITY_AUTH_TOKEN }}

jobs:
  coverity:
    name: Coverity Connect Scan (Windows)
    runs-on: [self-hosted, windows]   # include any extra custom labels if you added them to the runner
    timeout-minutes: 90

    steps:
      # -----------------------------------------------------------
      # CHECKOUT
      # -----------------------------------------------------------
      - name: Checkout source
        uses: actions/checkout@v4

      # -----------------------------------------------------------
      # DEBUG PATH — ONE-TIME CHECK (kept for this run; remove later)
      # -----------------------------------------------------------
      - name: Debug PATH and pwsh availability
        shell: cmd
        run: |
          echo =================================================================
          echo MACHINE PATH visible to this job:
          echo =================================================================
          echo %PATH%
          echo =================================================================
          echo Checking pwsh on PATH:
          where pwsh
          echo =================================================================
          echo Checking Windows PowerShell:
          where powershell
          echo =================================================================

      # -----------------------------------------------------------
      # VERIFY ENVIRONMENT — MUST RUN UNDER pwsh
      # -----------------------------------------------------------
      - name: Verify runner environment
        shell: pwsh
        run: |
          Write-Host "Runner OS: $env:RUNNER_OS"
          Write-Host "pwsh version: $($PSVersionTable.PSVersion)"
          if ($env:RUNNER_OS -ne "Windows") {
            throw "This job requires a Windows self-hosted runner."
          }

      # -----------------------------------------------------------
      # ADD COVERITY TO PATH
      # -----------------------------------------------------------
      - name: Add Coverity tools to PATH
        shell: pwsh
        run: |
          $bin = "${env:COVERITY_BIN_DIR}"
          if (-not (Test-Path $bin)) {
            throw "COVERITY_BIN_DIR not found: $bin"
          }
          # Append to PATH for all subsequent steps in this job
          Write-Host "Adding to PATH: $bin"
          $bin | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      # -----------------------------------------------------------
      # VERIFY COVERITY CLI (robust; no --version for cov-commit-defects)
      # -----------------------------------------------------------
      - name: Verify Coverity CLI presence
        shell: pwsh
        run: |
          $missing = @()
          foreach ($cmd in @('cov-build','cov-analyze','cov-commit-defects')) {
            if (-not (Get-Command $cmd -ErrorAction SilentlyContinue)) {
              $missing += $cmd
            }
          }
          if ($missing.Count -gt 0) {
            throw "Missing Coverity tools on PATH: $($missing -join ', '). Check COVERITY_BIN_DIR/installation."
          }

          # Optional: show the resolved tool locations
          Write-Host "cov-build:          $((Get-Command cov-build).Source)"
          Write-Host "cov-analyze:        $((Get-Command cov-analyze).Source)"
          Write-Host "cov-commit-defects: $((Get-Command cov-commit-defects).Source)"

          # Smoke tests that return success without requiring arguments
          cov-build --help   | Out-Null; if ($LASTEXITCODE -ne 0) { throw "cov-build not runnable" }
          cov-analyze --help | Out-Null; if ($LASTEXITCODE -ne 0) { throw "cov-analyze not runnable" }
          cov-commit-defects --help | Out-Null; if ($LASTEXITCODE -ne 0) { throw "cov-commit-defects not runnable" }

          # If you want version strings, these two support --version:
          cov-build --version
          cov-analyze --version

      # -----------------------------------------------------------
      # CLEAN + CREATE COV-INT DIRECTORY
      # -----------------------------------------------------------
      - name: Prepare cov-int directory
        shell: pwsh
        run: |
          if (Test-Path "cov-int") { Remove-Item -Recurse -Force cov-int }
          New-Item -ItemType Directory -Path cov-int | Out-Null

      # -----------------------------------------------------------
      # BUILD — choose the one that fits your project (examples below)
      # -----------------------------------------------------------

      # Example: .NET / C#
      - name: Build (.NET) via cov-build
        shell: pwsh
        run: |
          cov-build --dir cov-int --fs-capture-search . -- dotnet build --configuration Release

      # Example: Java / Maven (uncomment and adjust if needed)
      # - name: Build (Maven) via cov-build
      #   shell: pwsh
      #   run: |
      #     cov-build --dir cov-int --fs-capture-search . -- mvn -B -DskipTests clean package

      # Example: C/C++ (MSBuild) (uncomment and adjust if needed)
      # - name: Build (MSBuild C/C++) via cov-build
      #   shell: pwsh
      #   run: |
      #     cov-build --dir cov-int --fs-capture-search . -- msbuild.exe MySolution.sln /p:Configuration=Release

      # -----------------------------------------------------------
      # ANALYZE
      # -----------------------------------------------------------
      - name: Cov-Analyze
        shell: pwsh
        run: |
          cov-analyze --dir cov-int --all --webapp-security

      # -----------------------------------------------------------
      # COMMIT DEFECTS — USER/PASSWORD AUTH
      # -----------------------------------------------------------
      - name: Commit defects (username/password)
        if: ${{ env.COVERITY_USER != '' && env.COVERITY_PASSWORD != '' }}
        shell: pwsh
        run: |
          $args = ""
          if ("$env:COVERITY_PROJECT" -ne "") {
            # careful quoting for a value with spaces
            $args = "--scm-project-name `"$env:COVERITY_PROJECT`""
          }

          cov-commit-defects `
            --dir cov-int `
            --url "$env:COVERITY_CONNECT_URL" `
            --stream "$env:COVERITY_STREAM" `
            --username "$env:COVERITY_USER" `
            --password "$env:COVERITY_PASSWORD" `
            $args

      # -----------------------------------------------------------
      # COMMIT DEFECTS — TOKEN AUTH
      # -----------------------------------------------------------
      - name: Commit defects (token)
        if: ${{ env.COVERITY_AUTH_TOKEN != '' }}
        shell: pwsh
        run: |
          $args = ""
          if ("$env:COVERITY_PROJECT" -ne "") {
            $args = "--scm-project-name `"$env:COVERITY_PROJECT`""
          }

          $tokenFile = "cov_token.txt"
          Set-Content -Path $tokenFile -Value $env:COVERITY_AUTH_TOKEN

          cov-commit-defects `
            --dir cov-int `
            --url "$env:COVERITY_CONNECT_URL" `
            --stream "$env:COVERITY_STREAM" `
            --auth-key-file $tokenFile `
            $args
