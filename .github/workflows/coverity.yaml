name: Coverity Connect Scan

on:
  push:
    branches: [ "main" ]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

env:
  # ==== Non-secret, set as Actions Variables (Settings → Secrets and variables → Actions → Variables) ====
  COVERITY_CONNECT_URL: ${{ vars.COVERITY_CONNECT_URL }}   # e.g. https://coverity.example.com
  COVERITY_STREAM: ${{ vars.COVERITY_STREAM }}             # e.g. my-repo-main
  COVERITY_PROJECT: ${{ vars.COVERITY_PROJECT }}           # optional
  COVERITY_BIN_DIR: ${{ vars.COVERITY_BIN_DIR }}           # e.g. /opt/coverity/bin (optional)

  # ==== Secrets (choose ONE method), set under Actions → Secrets ====
  COVERITY_USER: ${{ secrets.COVERITY_USER }}              # Option A: user
  COVERITY_PASSWORD: ${{ secrets.COVERITY_PASSWORD }}      # Option A: password
  COVERITY_AUTH_TOKEN: ${{ secrets.COVERITY_AUTH_TOKEN }}  # Option B: token

jobs:
  coverity-connect:
    name: Coverity Connect
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure Coverity tools on PATH
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "${COVERITY_BIN_DIR:-}" ]; then
            echo "${COVERITY_BIN_DIR}" >> "$GITHUB_PATH"
          fi
          command -v cov-build || echo "cov-build not found"
          command -v cov-analyze || echo "cov-analyze not found"
          command -v cov-commit-defects || echo "cov-commit-defects not found"

      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Prepare capture directory
        run: |
          rm -rf cov-int
          mkdir -p cov-int

      # ===== Choose ONE build. Example: Make (C/C++) =====
      - name: Build with cov-build (Make example)
        run: |
          cov-build --dir cov-int --fs-capture-search . -- make -j"$(nproc)"

      # ===== If Java/.NET, replace the step above with one of these examples =====
      # - name: Setup Java
      #   uses: actions/setup-java@v4
      #   with:
      #     distribution: temurin
      #     java-version: "17"
      # - name: Build (Maven) via cov-build
      #   run: |
      #     cov-build --dir cov-int --fs-capture-search . -- mvn -B -DskipTests clean package
      #
      # - name: Setup .NET
      #   uses: actions/setup-dotnet@v4
      #   with:
      #     dotnet-version: "8.0.x"
      # - name: Build (.NET) via cov-build
      #   run: |
      #     cov-build --dir cov-int --fs-capture-search . -- dotnet build --configuration Release

      - name: Analyze
        run: |
          cov-analyze --dir cov-int --all --webapp-security

      # === Commit with username/password (only runs if both are set) ===
      - name: Commit defects (user/password)
        if: env.COVERITY_USER != '' && env.COVERITY_PASSWORD != ''
        run: |
          ARGS=""
          if [ -n "${COVERITY_PROJECT:-}" ]; then
            ARGS="--scm-project-name ${COVERITY_PROJECT}"
          fi
          cov-commit-defects \
            --dir cov-int \
            --url "${COVERITY_CONNECT_URL}" \
            --stream "${COVERITY_STREAM}" \
            --username "${COVERITY_USER}" \
            --password "${COVERITY_PASSWORD}" \
            ${ARGS}

      # === Commit with token (only runs if token is set) ===
      - name: Commit defects (token)
        if: env.COVERITY_AUTH_TOKEN != ''
        shell: bash
        run: |
          ARGS=""
          if [ -n "${COVERITY_PROJECT:-}" ]; then
            ARGS="--scm-project-name ${COVERITY_PROJECT}"
          fi
          # If your Connect supports --auth-key-file
          cov-commit-defects \
            --dir cov-int \
            --url "${COVERITY_CONNECT_URL}" \
            --stream "${COVERITY_STREAM}" \
            --auth-key-file <(printf "%s" "${COVERITY_AUTH_TOKEN}") \
            ${ARGS}

      # Optional SARIF (only if your version supports it)
      # - name: Generate SARIF
      #   run: |
      #     cov-format-errors --dir cov-int --types all --sarif-output results.sarif
      # - name: Upload SARIF
      #   uses: github/codeql-action/upload-sarif@v3
      #   with:
      #     sarif_file: results.sarif
